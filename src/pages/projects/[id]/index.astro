---
import ProjectDesc from "../../../components/ProjectDesc.astro";
import Base from "../../../layouts/Base.astro";
import CardGrid from "../../../layouts/CardGrid.astro";

import { Image } from "astro:assets";
import type { ComponentProps } from "astro/types";
import { type CollectionEntry, getCollection } from "astro:content";

type CardProps = ComponentProps<typeof CardGrid>;

export const getStaticPaths = async () => {
  const projects = await getCollection("projects");
  const blog = await getCollection("blog");

  return projects.map((project) => {
    // TODO(Unavailable): sort these automatically.
    const cards = project.data.items.map((item) => {
      if ("url" in item) return item;
      if ("group" in item)
        return {
          ...item,
          url: `/projects/${project.id}/${item.group}`,
        };

      const { id: blogId, data: blogPost } = blog.find(
        (post) => post.id === item.blog.id,
      )!;
      return {
        title: blogPost.title,
        url: `/blog/${blogId}`,
        image: blogPost.heroImage,
        date: blogPost.pubDate,
        tags: blogPost.tags,
      };
    });

    project.data.items = [];

    return {
      params: { id: project.id },
      props: { ...project, items: cards },
    };
  });
};

type Props = CollectionEntry<"projects"> & CardProps;

const props = Astro.props;
---

<Base title={props.data.title}>
  <main>
    <section class="space-y-5 md:space-y-8">
      <h1
        class="px-2 text-center font-['Montserrat'] text-2xl font-bold md:text-4xl"
      >
        {props.data.title}
      </h1>
      <Image
        class="mx-auto md:container md:max-w-(--breakpoint-xl)"
        src={props.data.banner}
        alt={props.data.title}
      />
      <ProjectDesc project={props} />
    </section>
    <hr class="mx-auto mt-4 max-w-(--breakpoint-xl) border-gray-500" />
    <CardGrid items={props.items} />
  </main>
</Base>
